#include "RTPiDrone_Quaternion.h"
#include "Common.h"
#include <stdlib.h>
#include <math.h>
#define DEG_TO_RAD      (M_PI/180)
#define RAD_TO_DEG      (180/M_PI)

static float Drone_Quaternion_getRoll(Drone_Quaternion*);
static float Drone_Quaternion_getPitch(Drone_Quaternion*);
static float Drone_Quaternion_getYaw(Drone_Quaternion*);

int Drone_Quaternion_Init(Drone_Quaternion** Quaternion)
{
    *Quaternion = (Drone_Quaternion*) calloc(1, sizeof(Drone_Quaternion));
    return 0;
}

void Drone_Quaternion_Delete(Drone_Quaternion** Quaternion)
{
    free(*Quaternion);
    *Quaternion = NULL;
}

void Drone_Quaternion_Normalize(Drone_Quaternion* Quaternion)
{
    float norm = getSqrt(Quaternion->q,4);
    for (int i=0; i<4; ++i) {
        Quaternion->q[i] /= norm;
    }
}

static float Drone_Quaternion_getRoll(Drone_Quaternion* Quaternion)
{
    float* q = Quaternion->q;
    return atan2(2 * q[2] * q[3] + 2 * q[0] * q[1], -2 * q[1] * q[1] - 2 * q[2]* q[2] + 1) * RAD_TO_DEG; // roll
}

static float Drone_Quaternion_getPitch(Drone_Quaternion* Quaternion)
{
    float* q = Quaternion->q;
    return asin(-2 * q[1] * q[3] + 2 * q[0]* q[2]) * RAD_TO_DEG; // pitch
}

static float Drone_Quaternion_getYaw(Drone_Quaternion* Quaternion)
{
    float* q = Quaternion->q;
    return atan2(2 * q[1] * q[2] + 2 * q[0] * q[3], -2 * q[2]*q[2] - 2 * q[3]*q[3] + 1) * RAD_TO_DEG; // yaw
}

